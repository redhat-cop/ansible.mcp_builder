---
# Setup uv/uvx for PyPI package installation
# This task file is idempotent and handles existing uv installations

- name: Check if uv is already available and working
  ansible.builtin.command: uv --version
  register: common_uv_existing
  changed_when: false
  failed_when: false

- name: Display existing uv version
  ansible.builtin.debug:
    msg: "Using existing uv installation: {{ common_uv_existing.stdout }}"
  when: common_uv_existing.rc == 0

- name: Install uv (if not already available)
  when: common_uv_existing.rc != 0
  block:
    - name: Download uv installer
      ansible.builtin.get_url:
        url: "{{ common_uv_installer_url }}"
        dest: "/tmp/uv-install.sh"
        mode: "0755"

    - name: Install uv using official installer
      ansible.builtin.shell: |
        set -o pipefail
        /tmp/uv-install.sh
      args:
        executable: /bin/bash
      register: common_uv_install_result
      changed_when: common_uv_install_result.rc == 0

    - name: Find uv installation path after fresh install
      ansible.builtin.stat:
        path: "{{ uv_path_item }}"
      loop:
        - "{{ lookup('env', 'HOME') }}/.cargo/bin/uv"
        - "{{ lookup('env', 'HOME') }}/.local/bin/uv"
      loop_control:
        loop_var: uv_path_item
      register: common_uv_path_check

    - name: Set uv path from installation
      ansible.builtin.set_fact:
        common_uv_path: "{{ uv_check.uv_path_item }}"
      loop: "{{ common_uv_path_check.results }}"
      when: uv_check.stat.exists
      loop_control:
        loop_var: uv_check
        label: "{{ uv_check.uv_path_item }}"

    - name: Create symlink for uv in system bin directory
      ansible.builtin.file:
        src: "{{ common_uv_path }}"
        dest: "{{ common_system_bin_path }}/uv"
        state: link
        force: true
      become: true
      when: common_uv_path is defined

    - name: Verify uv installation after fresh install
      ansible.builtin.command: uv --version
      register: common_uv_new_version
      changed_when: false
      failed_when: common_uv_new_version.rc != 0

    - name: Display newly installed uv version
      ansible.builtin.debug:
        msg: "Installed uv version: {{ common_uv_new_version.stdout }}"
      when: common_uv_new_version.rc == 0

    - name: Remove uv installer script
      ansible.builtin.file:
        path: "/tmp/uv-install.sh"
        state: absent

# Override image default Python with specified Python interpreter
- name: Detect Python version for uv tool installs
  vars:
    python_cmd: "{{ ansible_python_interpreter | default('python3') }}"
  ansible.builtin.command:
    cmd: >-
      {{ python_cmd }} -c
      "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')"
  register: common_python_version_output
  changed_when: false
  when: common_python_version is not defined

- name: Set detected Python version
  ansible.builtin.set_fact:
    common_detected_python_version: "{{ common_python_version_output.stdout }}"
  when: common_python_version is not defined

- name: Set PyPI installation flag
  ansible.builtin.set_fact:
    common_pypi_installed: true
