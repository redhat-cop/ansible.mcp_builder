---
# PyPI & uv installation tasks

- name: Include pypi setup tasks
  ansible.builtin.include_tasks: pypi_setup.yml
  when: not common_pypi_installed

- name: Install PyPI MCP server package
  ansible.builtin.command:
    cmd: >-
      uv tool install
      --python {{ common_python_version | default(common_detected_python_version) }}
      {{ common_package_name }}@{{ common_server_version }}
  environment:
    UV_TOOL_BIN_DIR: "{{ common_mcp_base_path }}/bin"
    UV_TOOL_DIR: "{{ common_mcp_base_path }}/.uv-tools"
  register: common_pypi_install_result
  failed_when: false
  changed_when: common_pypi_install_result.rc == 0

- name: Display successfully installed PyPI package
  ansible.builtin.debug:
    msg: "Installed {{ common_package_name }}@{{ common_server_version }}"
  when:
    - common_pypi_install_result is defined
    - common_pypi_install_result.rc == 0

- name: Display failed PyPI package installation
  ansible.builtin.debug:
    msg: "Failed to install PyPI package: {{ common_package_name }}"
  when:
    - common_pypi_install_result is defined
    - common_pypi_install_result.rc != 0

- name: Check if PyPI package executable exists
  ansible.builtin.stat:
    path: "{{ common_mcp_base_path }}/bin/{{ common_package_name }}"
  register: common_pypi_executable_check

- name: Display verification result
  ansible.builtin.debug:
    msg: >-
      PyPI package {{ common_package_name }}
      {{ 'installed successfully - executable found at ' + common_mcp_base_path + '/bin/' + common_package_name
      if common_pypi_executable_check.stat.exists
      else 'WARNING: executable not found at expected location' }}
  when: ansible_verbosity >= 2

- name: Verify executable runs
  ansible.builtin.command:
    cmd: "{{ common_mcp_base_path }}/bin/{{ common_package_name }} --version"
  register: common_pypi_verify_result
  changed_when: false
  failed_when: false
  when: common_pypi_executable_check.stat.exists

- name: Display execution result
  ansible.builtin.debug:
    msg: "Executable test: {{ 'passed' if common_pypi_verify_result.rc == 0 else 'failed (may not support --version flag)' }}"
  when:
    - ansible_verbosity >= 2
    - common_pypi_verify_result is defined
