---
# Node.js and npm installation tasks

- name: "Check if Node.js is already installed (minimum version: {{ common_nodejs_min_version }})"
  ansible.builtin.shell: |
    set -o pipefail
    if command -v node >/dev/null 2>&1; then
      node_version=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
      if [ "$node_version" -ge {{ common_nodejs_min_version }} ]; then
        echo "sufficient"
      else
        echo "insufficient"
      fi
    else
      echo "not_installed"
    fi
  args:
    executable: /bin/bash
  register: common_node_check
  changed_when: false

- name: "Install Node.js from NodeSource (version: {{ common_nodejs_min_version }})"
  when: common_node_check.stdout != "sufficient"
  block:
    - name: Set up NodeSource repository and install Node.js
      ansible.builtin.include_tasks: nodesource_setup.yml

- name: Verify Node.js installation
  ansible.builtin.command: node --version
  register: common_node_version_output
  changed_when: false

- name: Assert Node.js is working
  ansible.builtin.assert:
    that:
      - common_node_version_output.rc == 0
      - common_node_version_output.stdout is defined
      - common_node_version_output.stdout != ""
    fail_msg: "Node.js installation verification failed - command 'node --version' did not work"
    success_msg: "Node.js {{ common_node_version_output.stdout }} verified successfully"

- name: Verify NPM installation
  ansible.builtin.command: npm --version
  register: common_npm_version_output
  changed_when: false

- name: Assert NPM is working
  ansible.builtin.assert:
    that:
      - common_npm_version_output.rc == 0
      - common_npm_version_output.stdout is defined
      - common_npm_version_output.stdout != ""
    fail_msg: "NPM installation verification failed - command 'npm --version' did not work"
    success_msg: "NPM {{ common_npm_version_output.stdout }} verified successfully"

- name: Create MCP servers directory
  ansible.builtin.file:
    path: "{{ common_mcp_base_path }}/npm_installs"
    state: directory
    mode: "0755"

- name: Initialize package.json for MCP servers
  ansible.builtin.command:
    cmd: npm init -y
    chdir: "{{ common_mcp_base_path }}/npm_installs"
    creates: "{{ common_mcp_base_path }}/npm_installs/package.json"

- name: Check if npm package is already installed
  ansible.builtin.stat:
    path: "{{ common_mcp_base_path }}/npm_installs/node_modules/{{ common_package_name }}"
  register: common_npm_package_check

- name: Install npm package
  ansible.builtin.command:
    cmd: npm install {{ common_package_name }}@{{ common_server_version }}
    chdir: "{{ common_mcp_base_path }}/npm_installs"
  register: common_npm_install_result
  changed_when: common_npm_install_result.rc == 0
  when:
    - not common_npm_package_check.stat.exists

- name: Display successfully installed npm package
  ansible.builtin.debug:
    msg: "Successfully installed npm MCP package: {{ common_package_name }}"
  when:
    - common_npm_install_result is defined
    - common_npm_install_result.rc == 0
    - ansible_verbosity >= 2

- name: Display failed npm package installation
  ansible.builtin.debug:
    msg: "Failed to install npm package: {{ common_package_name }}"
  when:
    - common_npm_install_result is defined
    - common_npm_install_result.rc != 0

- name: Verify npm package is installed
  ansible.builtin.command:
    cmd: npm list --prefix {{ common_mcp_base_path }}/npm_installs {{ common_package_name }}
  register: common_npm_verify_result
  changed_when: false

- name: Display npm package verification result
  ansible.builtin.debug:
    msg: >-
      npm package {{ common_package_name }}:
      {{ 'installed successfully' if common_npm_verify_result.rc == 0
      else 'verification failed' }}

# Clean up
- name: Clean npm cache (created during package install)
  ansible.builtin.command: npm cache clean --force
  failed_when: false
  changed_when: false
