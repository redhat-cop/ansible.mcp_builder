---
# Go installation tasks

- name: Initialize Go build details dictionary
  ansible.builtin.set_fact:
    common_go_build_details: {}

- name: Get Go build details from role variables
  ansible.builtin.set_fact:
    common_go_build_details: "{{ common_go_build_details | combine(new_entry) }}"
  vars:
    var_key: "{{ build_var.replace(common_parent_role_prefix + '_build_', '') }}"
    var_value: "{{ lookup('vars', build_var) }}"
    new_entry: "{{ {var_key: var_value} }}"
  loop: "{{ q('varnames', common_parent_role_prefix + '_build_.+') }}"
  loop_control:
    loop_var: build_var
  when: common_parent_role_prefix is defined

- name: Set Go build info from registry entry
  ansible.builtin.set_fact:
    common_go_build_repo: "{{ common_go_build_details.repo }}"
    common_go_build_branch: "{{ common_go_build_details.repo_branch }}"
    common_go_build_path: "{{ common_go_build_details.path }}"
  when: common_go_build_details | length > 0

- name: Install Go
  when: not common_go_installed
  block:
    - name: Detect system architecture
      ansible.builtin.command:
        cmd: uname -m
      register: go_uname_arch
      changed_when: false

    - name: Set Go architecture
      ansible.builtin.set_fact:
        go_arch: "{{ 'arm64' if go_uname_arch.stdout in ['arm64', 'aarch64'] else 'amd64' if go_uname_arch.stdout == 'x86_64' else 'unsupported' }}"

    - name: Fail if architecture is unsupported
      ansible.builtin.fail:
        msg: "Unsupported architecture: {{ go_uname_arch.stdout }}. Only x86_64 (amd64) and arm64/aarch64 are supported for Go builds."
      when: go_arch == 'unsupported'

    - name: Display Go download details
      ansible.builtin.debug:
        msg: "Downloading Go {{ common_golang_version }} for linux-{{ go_arch }}"

    - name: Create Go installation directory
      ansible.builtin.file:
        path: /usr/local
        state: directory
        mode: "0755"
      become: true

    - name: Download and extract Go
      ansible.builtin.unarchive:
        src: "https://golang.org/dl/go{{ common_golang_version }}.linux-{{ go_arch }}.tar.gz"
        dest: /usr/local
        remote_src: true
        owner: root
        group: root
        mode: "0755"
        creates: /usr/local/go/bin/go
      become: true

    - name: Set Go environment variables
      ansible.builtin.lineinfile:
        path: /etc/environment
        line: "{{ go_env_item }}"
        create: true
        mode: "0644"
      loop:
        - 'PATH="/usr/local/go/bin:$PATH"'
      loop_control:
        loop_var: go_env_item
      become: true

    - name: Mark Go as installed
      ansible.builtin.set_fact:
        common_go_installed: true

- name: Build and install server
  when: common_go_build_path is defined
  block:
    - name: Set Go build path from registry entry
      ansible.builtin.set_fact:
        common_build_path: "{{ common_mcp_base_path }}/{{ common_go_build_path }}"
        common_binary_full_path: "{{ common_mcp_base_path }}/bin/{{ common_package_name }}"

    - name: Create build directory
      ansible.builtin.file:
        path: "{{ common_build_path }}"
        state: directory
        mode: "0755"
      become: true

    - name: Clone source repository
      ansible.builtin.git:
        repo: "{{ common_go_build_repo }}"
        dest: "{{ common_build_path }}"
        version: "{{ common_go_build_branch }}"
        force: true
      become: true
      environment:
        PATH: "/usr/local/go/bin:/usr/local/bin:/usr/bin:/bin"

    - name: Download Go modules
      ansible.builtin.command:
        cmd: go mod download
        chdir: "{{ common_build_path }}"
        creates: "{{ common_build_path }}/go.sum"
      become: true
      environment:
        PATH: "/usr/local/go/bin:/usr/local/bin:/usr/bin:/bin"
        CGO_ENABLED: "0"

    - name: Build MCP Server binary
      ansible.builtin.command:
        cmd: go build -ldflags="-s -w" -o "{{ common_mcp_base_path }}/bin/{{ common_package_name }}" ./cmd/{{ common_package_name }}/
        chdir: "{{ common_build_path }}"
        creates: "{{ common_binary_full_path }}"
      become: true
      environment:
        PATH: "/usr/local/go/bin:/usr/local/bin:/usr/bin:/bin"
        CGO_ENABLED: "0"

    - name: Make MCP Server binary executable
      ansible.builtin.file:
        path: "{{ common_binary_full_path }}"
        mode: "0755"
      become: true

    - name: Clean up build directory
      ansible.builtin.file:
        path: "{{ common_build_path }}"
        state: absent
      become: true

    - name: Create symlinks for Go binaries in system bin directory
      ansible.builtin.file:
        src: "{{ common_binary_full_path }}"
        dest: "{{ common_go_binary_dest_path }}"
        state: link
        force: true
      become: true
      vars:
        common_go_binary_dest_path: "{{ common_system_bin_path }}/{{ common_package_name }}"

# Clean up

- name: Remove Go toolchain
  ansible.builtin.file:
    path: /usr/local/go
    state: absent
  become: true

- name: Remove Go from PATH in environment
  ansible.builtin.lineinfile:
    path: /etc/environment
    regex: "^PATH.*go/bin.*"
    state: absent
  become: true

- name: Remove Go installer tarball
  ansible.builtin.file:
    path: /tmp/go*.tar.gz
    state: absent
  become: true
